---
title: "QResearch"
author: "IsaevaA.S."
date: "2025-01-15"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(TrialSize)
library(epiR)
library(DescTools)
library(reprex)
```

# Рассчитайте объёмы выборок для следующих клинических исследований. Опишите предположения, которые были выдвинуты при анализе. Воспользуйтесь примером оформления результатов, который приведён далее. Частота выбывания пациентов в ходе исследования – 20%. Частота выбывания пациентов в ходе скрининга – 10%.

## 1. Исследование ***не меньшей эффективности*** препарата T в сравнении с препаратом R в лечении хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите. Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей эффективности – 2 %.

Статистическая гипотеза не меньшей эффективности в исследовании была
сформулирована следующим образом:

H0: T – R ≤ δ

HA: T – R \> δ

Где T – абсолютный прирост индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии
в сравнении со значениями на 1 визите, R – абсолютный прирост индекса
Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1
визите в контрольной группе. δ – граница не меньшей эффективности (-2%).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1\. Распределение в группы будет равномерным в соотношении 1:1;

2\. Односторонняя величина ошибки I рода (α) составляет 0.025;

3\. Мощность исследования должна составлять 80%, соответственно,
предельная величина ошибки II рода (β) = 0.2;

4\. На основании литературных данных мы ожидаем величину эффекта в
группе исследуемого препарата (T) и референсного препарата (R) \~ 7.2 ±
3.1%.

5\. Граница не меньшей эффективности препарата по сравнению с референсом
равна -2%.

6\. Стандартные отклонения в группах исследуемого препарата (T) и
референсного (R) равны 3.1%.

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build
394) c использованием языка R (версия 4.3.0) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.

***Примечание: Не очень понятно, когда округлять. Я бы округляла после
функции, а при подсчетах 20% и 10% использовала бы не округленные
значения n из функции и округляла бы после деления. Но оставила так, тк
совпадает с Вашими выводами в примере при n\<-361.0485***

```{r}

n<-TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 3.1,
    k = 1,
    delta = 0,
    margin = -2
)
n #количество обследуемых в группе полученные из функкции
ceiling(n) #округляем до натурального
ceiling(n)*2 #количество обследуемых всего
a<-n/0.8 
ceiling(a) #количество обследуемых в группе с учетом 20% частоты выбывания
s<-ceiling(a)/0.9
ceiling(s) #количество обследуемых в группе скрининга с учетом 10% частоты выбывания


```

Таким образом, в каждую группу необходимо включить не менее 38
обследуемых, всего – 76 пациентов. С учётом частоты выбывания пациентов
в ходе исследования, равной 20%, в каждую группу необходимо набрать не
менее 48 человек.

В скрининг (с учётом 10% выбывания) необходимо включить не менее 54
обследуемых в каждую группу.

## 2. Исследование превосходства препарата T над референтным лечением R в лечении рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом:

H0: PT – PR ≤ δ

HA: PT – PR \> δ

Где PT – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов
по МРТ в группе исследуемого препарата, R – доля пациентов, у которых к
визиту 3 (12 мес.) нет новых очагов по МРТ в группе препарата сравнения.
δ – граница превосходства (1%).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1\. Распределение в группы будет равномерным в соотношении 2:1
(исследуемый препарат : референсный препарат);

2\. Односторонняя величина ошибки I рода (α) составляет 0.025;

3\. Мощность исследования должна составлять 80%, соответственно,
предельная величина ошибки II рода (β) = 0.2;

4\. На основании литературных данных мы ожидаем величину эффекта в
группе исследуемого препарата (PT) 81%. и в группе референсного
препарата (RT) 66%.

5\. Граница превосходства препарата по сравнению с референсом равна 1%.

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build
394) c использованием языка R (версия 4.3.0) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.

```{r}
#?TwoSampleProportion.NIS()
n<-TwoSampleProportion.NIS(
      alpha = 0.025,
      beta = 0.2,
      p1 = 0.81,
      p2 = 0.66,
      k = 2,
      delta = 0.15,
      margin = 0.01
)
n #количество обследуемых в группе полученные из функкции (в данном случае в группе PT)
ceiling(n) #округляем до натурального
ceiling(n)*3/2 #количество обследуемых всего
ceiling(n)*3/2-ceiling(n)#количество в группе референтного препарата PR
t<-n/0.8 
ceiling(t) #количество обследуемых в группе T с учетом 20% частоты выбывания
r<-(n*3/2-n)/0.8
ceiling(r) ##количество обследуемых в группе R с учетом 20% частоты выбывания
st<-ceiling(t)/0.9
ceiling(st) #количество обследуемых в группе T скрининга с учетом 10% частоты выбывания
sr<-ceiling(r)/0.9
ceiling(sr) #количество обследуемых в группе R скрининга с учетом 10% частоты выбывания

```

Таким образом, в группу исследуемого препарата необходимо включить не
менее 242 обследуемых, в группу препарата сравнения 121, всего – 363
пациентов. С учётом частоты выбывания пациентов в ходе исследования,
равной 20%, в группу исследуемого препарата необходимо набрать 302
обследуемых, в группу препарата сравнения 151.

В скрининг (с учётом 10% выбывания) необходимо включить не менее 336
обследуемых в группу исследуемого препарата и 168 в группу препарата
сравнения.

## 3. Исследование превосходства нового препарата А над препаратом Б в профилактике интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.

Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом:

H0: А – Б ≥ - δ

HA: А – Б \< - δ

Где А – объём кровопотери (мл) в группе с препаратом А, Б – объём
кровопотери (мл) в группе с препаратом Б. δ – граница не меньшей
эффективности (50 мл).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1\. Распределение в группы будет равномерным в соотношении 3:1 (группа
препарата А : группа препарата Б);

2\. Односторонняя величина ошибки I рода (α) составляет 0.025;

3\. Мощность исследования должна составлять 80%, соответственно,
предельная величина ошибки II рода (β) = 0.2;

4\. На основании литературных данных мы ожидаем величину эффекта в
группе исследуемого препарата (А) 244.8 и референсного препарата (Б) \~
306.

5\. Граница превосходства препарата A по сравнению с Б равна 50 мл.

6\. Стандартные отклонения в группах исследуемого препарата (А) и
референсного (Б) равны 52 мл.

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build
394) c использованием языка R (версия 4.3.0) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.

```{r}
n<-epi.sssupc(
    treat = 244.8,
    control = 306,
    sigma = 52,
    delta = 50,
    alpha = 0.025,
    power = 0.8,
    n = NA,
    r = 3
)


n 
ceiling(n$n.control/0.8)*3
ceiling(n$n.control/0.8)
ceiling(n$n.control/0.8/0.9)*3
ceiling(n$n.control/0.8/0.9)


```

Таким образом, в группу исследуемого препарата А необходимо включить не
менее 9 обследуемых, в группу препарата сравнения Б 3, всего – 12
пациентов. С учётом частоты выбывания пациентов в ходе исследования,
равной 20%, в группу исследуемого препарата необходимо набрать 12
обследуемых, в группу препарата сравнения 4.

В скрининг (с учётом 10% выбывания) необходимо включить не менее 15
обследуемых в группу исследуемого препарата и 5 в группу препарата
сравнения.

## 4. Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%. При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования.

Статистическая гипотеза превосходства в исследовании была сформулирована
следующим образом:

H0: PY – PX ≥ - δ

HA: PY – PX \< - δ

Где PY – доля пациентов в группе исследуемого препарата Y, у которых за
6 месяцев наблюдается рецидив псориатического артрита, PX – доля
пациентов в группе референсного препарата X, у которых за 6 месяцев
наблюдается рецидив псориатического артрита. δ – граница превосходства
(5%).

При расчёте необходимого размера выборки были сделаны следующие
допущения:

1\. Распределение в группы будет равномерным, соотношение зависит от
общего количества пачек препарата (250 пачек);

2\. Односторонняя величина ошибки I рода (α) составляет 0.025;

3\. Мощность исследования должна составлять 80%, соответственно,
предельная величина ошибки II рода (β) = 0.2;

4\. Мы ожидаем величину эффекта в группе исследуемого препарата (Y) 17%
и референсного препарата (X) \~ 32%.

5\. Граница превосходства препарата A по сравнению с Б равна 5%.

Расчёт размера выборки был проведён в RStudio (версия 2024.09.1 Build
394) c использованием языка R (версия 4.3.0) с помощью функции
TwoSampleProportion.NIS пакета TrialSize (версия 1.4).

Результаты расчёта представлены далее.

```{r}

a<-250-250*0.3
a #Допустимый минимум пациентов без учета выпадения

n<-epi.sssupb(
    treat = 0.17,
    control = 0.32,
    delta = 0.05,
    alpha = 0.025,
    power = 0.8,
    r = 1,
    n = NA
)
n #Минимум пациентов без учета выпадения согласно функции
ceiling(n$n.treat/0.8) #Минимум пациентов с учетом выпадения в группе препарата Y
ceiling(n$n.control/0.8) #Минимум пациентов с учетом выпадения в группе препарата X
ceiling(n$n.treat/0.8/0.9) #Минимум пациентов с учетом выпадения на скрининге в группе препарата Y
ceiling(n$n.control/0.8/0.9) #Минимум пациентов с учетом выпадения на скрининге в группе препарата X


```

Таким образом, в группу исследуемого препарата Y и в группу препарата
сравнения X необходимо включить не менее 71 обследуемых, всего – 142
пациентов. С учётом частоты выбывания пациентов в ходе исследования,
равной 20%, в группу исследуемого препарата и препарата сравнения
необходимо набрать по 89 обследуемых.

В скрининг (с учётом 10% выбывания) необходимо включить по 99
обследуемых в группу исследуемого препарата и в группу препарата
сравнения.
